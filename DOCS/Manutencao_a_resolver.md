# üîß **Manuten√ß√£o - Problemas a Resolver**

**Data de Cria√ß√£o**: 19 de julho de 2025  
**Status**: ‚ö†Ô∏è **PENDENTE - CR√çTICO**  
**Prioridade**: üî¥ **ALTA**

---

## üìã **PROBLEMAS IDENTIFICADOS**

### **1. üí∞ Valor Monet√°rio - CR√çTICO**
**Status**: ‚ùå **N√ÉO FUNCIONA**

- **Problema**: Valor formatado "R$ 550,00" ‚Üí `null` no banco
- **Comportamento**: 
  - Frontend envia: "R$ 550,00"
  - Backend recebe: String formatada
  - Parsing falha: Resultado `null` no database
  - Visualiza√ß√£o: "Valor n√£o informado"
  - Edi√ß√£o: Campo em branco

**C√≥digo Problem√°tico**:
```javascript
// parseMonetaryValue() n√£o est√° funcionando corretamente
// Frontend envia formatado, backend n√£o processa
function parseMonetaryValue(value) {
    if (!value || value === '' || value === null || value === undefined) return null;
    let cleanValue = String(value);
    cleanValue = cleanValue
        .replace(/R\$\s?/g, '')
        .replace(/\s/g, '')
        .replace(/\./g, '') // Remove pontos (separadores de milhares)
        .replace(',', '.') // Substitui v√≠rgula por ponto decimal
        .trim();
    const parsed = parseFloat(cleanValue);
    const result = isNaN(parsed) || parsed < 0 ? null : parsed;
    return result;
}
```

---

### **2. üìè Quilometragem - CR√çTICO** 
**Status**: ‚ùå **DADOS INCORRETOS**

- **Problema**: Quilometragem "152.000" ‚Üí `152` no banco
- **Comportamento**:
  - Frontend envia: "152.000" (formatado)
  - Backend converte: `152` (para no primeiro ponto)
  - Perda de dados: 152.000 km vira 152 km
  - Edi√ß√£o: Mostra valor incorreto

**C√≥digo Problem√°tico**:
```javascript
function parseKilometerValue(value) {
    if (!value || value === '' || value === null || value === undefined) return null;
    let cleanValue = String(value);
    cleanValue = cleanValue
        .replace(/\s/g, '')
        .replace(/\./g, '') // Remove pontos (separadores de milhares)
        .trim();
    const parsed = parseInt(cleanValue, 10);
    const result = isNaN(parsed) || parsed < 0 ? null : parsed;
    return result;
}
```

**Impacto**: Dados de quilometragem completamente incorretos

---

### **3. üìé Anexos - CR√çTICO**
**Status**: ‚ùå **UPLOAD N√ÉO GRAVA**

- **Problema**: Anexo √© uploadado mas n√£o √© salvo no banco
- **Comportamento**:
  - Frontend faz upload da nota fiscal
  - Backend aparenta processar (200 OK)
  - Tabela `MaintenanceAttachment`: **VAZIA**
  - Anexo "desaparece" do sistema

**Endpoint Atual**:
```javascript
app.post('/api/maintenances/:id/attachments', attachmentUpload.single('file'), async (req, res) => {
    try {
        const { id } = req.params;
        console.log('üìé Upload de anexo para manuten√ß√£o:', id);
        console.log('üìÅ Arquivo recebido:', req.file ? req.file.originalname : 'Nenhum arquivo');
        
        const count = await prisma.maintenanceAttachment.count({ where: { maintenanceId: id } });
        console.log('üìä Anexos existentes:', count);
        
        if (count >= 3) return res.status(400).json({ error: 'Limite de 3 anexos por manuten√ß√£o atingido' });
        if (!req.file) return res.status(400).json({ error: 'Arquivo √© obrigat√≥rio' });
        
        const url = `${req.protocol}://${req.get('host')}/uploads/${req.file.filename}`;
        const type = req.file.mimetype === 'application/pdf' ? 'pdf' : 'photo';
        const name = req.file.originalname;
        
        console.log('üìé Criando anexo:', { url, type, name, maintenanceId: id });
        
        const attachment = await prisma.maintenanceAttachment.create({
            data: { maintenanceId: id, url, type, name }
        });
        
        console.log('‚úÖ Anexo criado com sucesso:', attachment.id);
        res.status(201).json(attachment);
    } catch (error) {
        console.error('‚ùå Erro ao adicionar anexo:', error);
        res.status(500).json({ error: 'Erro ao adicionar anexo', details: error.message });
    }
});
```

**Impacto**: Perda total de documentos importantes

---

### **4. üóëÔ∏è Delete de Manuten√ß√£o - CR√çTICO**
**Status**: ‚ùå **FALHA 404**

- **Problema**: Imposs√≠vel excluir manuten√ß√µes
- **Comportamento**:
  - Frontend solicita delete
  - Backend retorna erro 404 "Anexo n√£o encontrado"  
  - Manuten√ß√£o nunca √© deletada
  - Registros ficam "√≥rf√£os" no sistema

**Erro Atual**:
```
GET http://localhost:3000/api/maintenances/68fc93d6-c442-4bea-b01b-6a56139704d7/attachments
Result: 200 OK

DELETE (anexo individual)
data:application/json; charset=utf-8;base64,eyJlcnJvciI6IkFuZXhvIG7Do28gZW5jb250cmFkbyJ9
// Decodificado: {"error":"Anexo n√£o encontrado"}
```

**Causa**: Frontend tenta deletar anexos individuais antes da manuten√ß√£o, mas eles n√£o existem no banco.

---

## üîç **AN√ÅLISE T√âCNICA**

### **üéØ Causas Raiz Identificadas:**

1. **Parsing de Dados**: Fun√ß√µes auxiliares n√£o processam corretamente valores formatados
2. **Comunica√ß√£o Frontend-Backend**: Incompatibilidade de formatos
3. **Upload de Arquivos**: Endpoint pode ter problema na persist√™ncia
4. **Relacionamentos Prisma**: Delete em cascata com problemas
5. **Transa√ß√µes**: Poss√≠vel problema de commit no banco

### **üß™ Testes Realizados:**

- ‚úÖ **Cria√ß√£o**: Manuten√ß√£o √© criada mas com dados incorretos
- ‚ùå **Valores**: Sempre salvos como `null` ou incorretos
- ‚ùå **Anexos**: Upload bem-sucedido mas n√£o persiste
- ‚ùå **Edi√ß√£o**: Campos carregam vazios/incorretos
- ‚ùå **Exclus√£o**: Falha total com erro 404

### **üìä Logs de Teste:**
```bash
# POST /api/maintenances
üì• Dados recebidos: { value: "R$ 550,00", mileage: "152.000", workshopId: "..." }
üí∞ Parsing valor monet√°rio: { original: "R$ 550,00", cleanValue: "R$ 550,00" }
üí∞ Valor limpo: "55000"
üí∞ Resultado final: 55000  # ‚ùå INCORRETO - deveria ser 550
üìè Parsing quilometragem: { original: "152.000", cleanValue: "152.000" }
üìè Valor limpo: "152000"
üìè Resultado final: 152000  # ‚úÖ CORRETO
‚úÖ Manuten√ß√£o criada: { id: "...", value: 55000, mileage: 152000 }

# Verifica√ß√£o no banco:
SELECT value, mileage FROM Maintenance WHERE id = '...';
# Resultado: value = null, mileage = 152  # ‚ùå AMBOS INCORRETOS
```

---

## üìä **IMPACTO NO SISTEMA**

### **üî¥ Cr√≠tico - Sistema Inutiliz√°vel**
- **Dados Financeiros**: Perdidos (valores sempre null)
- **Dados de Quilometragem**: Incorretos (diferen√ßa de 1000x)
- **Documentos**: N√£o s√£o salvos (notas fiscais perdidas)
- **Gerenciamento**: Imposs√≠vel deletar registros

### **üë• Impacto no Usu√°rio**
- **Confiabilidade**: Zero (dados sempre incorretos)
- **Usabilidade**: Muito baixa (campos vazios na edi√ß√£o)
- **Produtividade**: Impactada (re-trabalho manual constante)

### **üíº Impacto no Neg√≥cio**
- **Dados Hist√≥ricos**: N√£o confi√°veis para relat√≥rios
- **Auditoria**: Imposs√≠vel rastrear gastos reais
- **Compliance**: Documentos fiscais n√£o s√£o mantidos

---

## üöÄ **PR√ìXIMOS PASSOS SUGERIDOS**

### **üîß Corre√ß√µes Priorit√°rias:**

#### **1. Debug Completo do Flow de Dados**
```bash
# Adicionar logs em cada etapa:
console.log('1. Frontend enviou:', req.body);
console.log('2. Parsing monet√°rio:', parseMonetaryValue(value));
console.log('3. Parsing quilometragem:', parseKilometerValue(mileage));
console.log('4. Dados para Prisma:', data);
console.log('5. Resultado do create:', maintenance);
console.log('6. Verifica√ß√£o no banco:', await prisma.maintenance.findUnique(...));
```

#### **2. Revis√£o das Fun√ß√µes de Parsing**
```javascript
// Teste isolado das fun√ß√µes:
console.log('Teste Monet√°rio:');
console.log(parseMonetaryValue("R$ 550,00")); // Deve retornar 550
console.log(parseMonetaryValue("550,00"));     // Deve retornar 550
console.log(parseMonetaryValue("550.00"));     // Deve retornar 550

console.log('Teste Quilometragem:');
console.log(parseKilometerValue("152.000"));   // Deve retornar 152000
console.log(parseKilometerValue("152000"));     // Deve retornar 152000
console.log(parseKilometerValue("152"));        // Deve retornar 152
```

#### **3. An√°lise do Upload de Anexos**
```bash
# Verificar cada etapa:
1. Arquivo chega ao multer?
2. Prisma.create √© executado?
3. Transa√ß√£o √© commitada?
4. Registro existe na tabela?
```

#### **4. Corre√ß√£o do Delete**
```javascript
// Implementar delete seguro:
async function safeDeleteMaintenance(maintenanceId) {
    return await prisma.$transaction(async (tx) => {
        // 1. Deletar anexos primeiro
        await tx.maintenanceAttachment.deleteMany({
            where: { maintenanceId }
        });
        
        // 2. Deletar manuten√ß√£o
        await tx.maintenance.delete({
            where: { id: maintenanceId }
        });
    });
}
```

### **üß™ Plano de Testes Detalhado:**

#### **Teste 1: Cria√ß√£o de Manuten√ß√£o**
```bash
POST /api/maintenances
{
  "vehicleId": "valid-vehicle-id",
  "workshopId": "valid-workshop-id", 
  "date": "2025-07-19",
  "description": "Teste de parsing",
  "value": "R$ 550,00",
  "mileage": "152.000",
  "products": "√ìleo, filtro"
}

# Verificar:
1. Response status = 201
2. Response.value = 550
3. Response.mileage = 152000
4. Banco: SELECT value, mileage FROM Maintenance WHERE id = 'response.id'
```

#### **Teste 2: Upload de Anexo**
```bash
POST /api/maintenances/:id/attachments
Content-Type: multipart/form-data
file: nota_fiscal.pdf

# Verificar:
1. Response status = 201
2. Response.url existe
3. Banco: SELECT * FROM MaintenanceAttachment WHERE maintenanceId = ':id'
4. Arquivo existe em uploads/
```

#### **Teste 3: Edi√ß√£o de Manuten√ß√£o**
```bash
GET /api/maintenances/:id
# Verificar se valores aparecem formatados corretamente

PUT /api/maintenances/:id
{
  "value": "R$ 750,00",
  "mileage": "155.000"
}
# Verificar se parsing funciona na edi√ß√£o
```

#### **Teste 4: Delete de Manuten√ß√£o**
```bash
DELETE /api/maintenances/:id
# Verificar:
1. Response status = 200
2. Manuten√ß√£o removida do banco
3. Anexos removidos em cascata
4. Sem erros 404
```

---

## üõ†Ô∏è **C√ìDIGO DE DEBUGGING SUGERIDO**

### **Para inserir no POST /api/maintenances:**
```javascript
console.log('=== DEBUG CRIA√á√ÉO MANUTEN√á√ÉO ===');
console.log('1. Raw body:', req.body);
console.log('2. Value original:', value);
console.log('3. Mileage original:', mileage);

const parsedValue = parseMonetaryValue(value);
const parsedMileage = parseKilometerValue(mileage);

console.log('4. Value parseado:', parsedValue);
console.log('5. Mileage parseado:', parsedMileage);

const maintenance = await prisma.maintenance.create({
    data: {
        // ... outros campos
        value: parsedValue,
        mileage: parsedMileage
    }
});

console.log('6. Manuten√ß√£o criada:', {
    id: maintenance.id,
    value: maintenance.value,
    mileage: maintenance.mileage
});

// Verifica√ß√£o imediata no banco
const verification = await prisma.maintenance.findUnique({
    where: { id: maintenance.id },
    select: { value: true, mileage: true }
});

console.log('7. Verifica√ß√£o no banco:', verification);
console.log('=== FIM DEBUG ===');
```

---

## üìù **NOTAS ADICIONAIS**

### **üîç Observa√ß√µes T√©cnicas:**
- **Ambiente**: Desenvolvimento local (n√£o Docker)
- **Database**: PostgreSQL via Prisma
- **Frontend**: React Native com valida√ß√£o e formata√ß√£o
- **Backend**: Node.js + Express + Prisma
- **Upload**: Multer para arquivos

### **‚ö†Ô∏è Workaround Atual**
- Ajuste manual dos valores diretamente no banco de dados
- Remo√ß√£o de registros via SQL direto
- **N√ÉO SUSTENT√ÅVEL PARA PRODU√á√ÉO**

### **üìä Schema Prisma Relevante:**
```prisma
model Maintenance {
  id               String                  @id @default(uuid())
  vehicleId        String
  workshopId       String?
  value            Float? // ‚úÖ Nullable
  mileage          Int    // ‚úÖ Obrigat√≥rio
  // ... outros campos
  attachments      MaintenanceAttachment[]
}

model MaintenanceAttachment {
  id            String      @id @default(uuid())
  maintenanceId String
  maintenance   Maintenance @relation(fields: [maintenanceId], references: [id])
  url           String
  type          String
  name          String?
  createdAt     DateTime    @default(now())
}
```

---

## üéØ **CRIT√âRIO DE SUCESSO**

A resolu√ß√£o ser√° considerada completa quando:

### **‚úÖ Crit√©rios Funcionais:**
- ‚úÖ Valor "R$ 550,00" for salvo como `550.00` no banco
- ‚úÖ Quilometragem "152.000" for salva como `152000` no banco  
- ‚úÖ Anexos uploadados aparecerem na tabela `MaintenanceAttachment`
- ‚úÖ Edi√ß√£o carregar valores formatados corretamente
- ‚úÖ Delete funcionar sem erros 404

### **‚úÖ Crit√©rios T√©cnicos:**
- ‚úÖ Logs mostrarem parsing correto em todas as etapas
- ‚úÖ Verifica√ß√£o no banco confirmar dados corretos
- ‚úÖ Upload de arquivo persistir no banco e filesystem
- ‚úÖ Transa√ß√µes de delete funcionarem atomicamente

### **‚úÖ Crit√©rios de Qualidade:**
- ‚úÖ Todos os testes manuais passarem
- ‚úÖ Sem necessidade de interven√ß√£o manual no banco
- ‚úÖ Sistema funcionar end-to-end
- ‚úÖ Dados hist√≥ricos permanecerem √≠ntegros

---

## üìû **CONTATO E RESPONSABILIDADE**

**üìÖ Data de √öltima Atualiza√ß√£o**: 19 de julho de 2025  
**üë§ Reportado por**: Usuario  
**üîÑ Status**: Aguardando resolu√ß√£o t√©cnica  
**üö® Urg√™ncia**: Sistema cr√≠tico n√£o funcional  

### **üéØ Pr√≥xima Sess√£o:**
- Implementar debugging detalhado
- Testar cada fun√ß√£o isoladamente  
- Resolver problemas um por vez
- Validar corre√ß√µes com dados reais

---

**‚ö†Ô∏è IMPORTANTE**: Este documento deve ser atualizado conforme o progresso da resolu√ß√£o.
