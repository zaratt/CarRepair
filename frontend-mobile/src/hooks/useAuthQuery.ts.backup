import AsyncStorage from '@react-native-async-storage/async-storage';
import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
import {
    AuthAPI,
    ChangePasswordRequest,
    LoginRequest,
    RegisterRequest
} from '../api/auth.api';
import { TokenManager } from '../api/client';
import { queryKeys, reactQueryUtils } from '../api/queryClient';

// ğŸ”‘ Hook para autenticaÃ§Ã£o com React Query
export const useAuthQuery = () => {
    const queryClient = useQueryClient();

    // ğŸ‘¤ Query para obter usuÃ¡rio atual
    const userQuery = useQuery({
        queryKey: queryKeys.auth.user,
        queryFn: async () => {
            const token = await TokenManager.getAccessToken();
            if (!token) {
                throw new Error('No token available');
            }
            return AuthAPI.getCurrentUser();
        },
        enabled: false, // SÃ³ executa quando chamado manualmente
        retry: false,
    });

    // ğŸšª Mutation para login
    const loginMutation = useMutation({
        mutationFn: async (credentials: LoginRequest) => {
            const response = await AuthAPI.login(credentials);

            // Salvar tokens
            await TokenManager.setTokens(response.tokens);

            // Salvar dados do usuÃ¡rio
            await AsyncStorage.setItem('user', JSON.stringify(response.user));

            return response;
        },
        onSuccess: (data) => {
            // Atualizar cache do usuÃ¡rio
            queryClient.setQueryData(queryKeys.auth.user, data.user);

            // Habilitar query do usuÃ¡rio
            queryClient.invalidateQueries({ queryKey: queryKeys.auth.user });
        },
        onError: (error) => {
            console.error('âŒ Erro no login:', error);
        },
    });

    // ğŸ“ Mutation para registro
    const registerMutation = useMutation({
        mutationFn: async (userData: RegisterRequest) => {
            const response = await AuthAPI.register(userData);

            // Salvar tokens
            await TokenManager.setTokens(response.tokens);

            // Salvar dados do usuÃ¡rio
            await AsyncStorage.setItem('user', JSON.stringify(response.user));

            return response;
        },
        onSuccess: (data) => {
            // Atualizar cache do usuÃ¡rio
            queryClient.setQueryData(queryKeys.auth.user, data.user);

            // Habilitar query do usuÃ¡rio
            queryClient.invalidateQueries({ queryKey: queryKeys.auth.user });
        },
        onError: (error) => {
            console.error('âŒ Erro no registro:', error);
        },
    });

    // ğŸšª Mutation para logout
    const logoutMutation = useMutation({
        mutationFn: async () => {
            const refreshToken = await TokenManager.getRefreshToken();

            // Fazer logout no servidor
            if (refreshToken) {
                await AuthAPI.logout(refreshToken);
            }

            // Limpar tokens e dados locais
            await Promise.all([
                TokenManager.clearTokens(),
                AsyncStorage.removeItem('user'),
                AsyncStorage.removeItem('onboarding_completed'),
            ]);
        },
        onSuccess: () => {
            // Limpar todos os caches
            reactQueryUtils.clearCache();

            console.log('âœ… Logout realizado com sucesso');
        },
        onError: (error) => {
            // Mesmo com erro, limpar dados locais
            console.warn('âš ï¸ Erro no logout, mas limpando dados locais:', error);

            Promise.all([
                TokenManager.clearTokens(),
                AsyncStorage.removeItem('user'),
                reactQueryUtils.clearCache(),
            ]);
        },
    });

    // ğŸ”„ Mutation para alterar senha
    const changePasswordMutation = useMutation({
        mutationFn: (data: ChangePasswordRequest) => AuthAPI.changePassword(data),
        onSuccess: () => {
            console.log('âœ… Senha alterada com sucesso');
        },
        onError: (error) => {
            console.error('âŒ Erro ao alterar senha:', error);
        },
    });

    // ğŸ“§ Mutation para esqueceu senha
    const forgotPasswordMutation = useMutation({
        mutationFn: (email: string) => AuthAPI.forgotPassword({ email }),
        onSuccess: () => {
            console.log('âœ… Email de recuperaÃ§Ã£o enviado');
        },
        onError: (error) => {
            console.error('âŒ Erro ao enviar email de recuperaÃ§Ã£o:', error);
        },
    });

    // ğŸ” FunÃ§Ã£o para verificar se estÃ¡ autenticado
    const checkAuthStatus = async (): Promise<boolean> => {
        try {
            const token = await TokenManager.getAccessToken();
            if (!token) return false;

            // Tentar obter dados do usuÃ¡rio
            const userData = await AuthAPI.getCurrentUser();

            // Atualizar cache
            queryClient.setQueryData(queryKeys.auth.user, userData);

            return true;
        } catch (error) {
            console.log('ğŸ” NÃ£o estÃ¡ autenticado:', error);

            // Limpar dados invÃ¡lidos
            await Promise.all([
                TokenManager.clearTokens(),
                AsyncStorage.removeItem('user'),
            ]);

            return false;
        }
    };

    // ğŸ”„ FunÃ§Ã£o para inicializar autenticaÃ§Ã£o (verificar token existente)
    const initializeAuth = async (): Promise<void> => {
        try {
            // Verificar se hÃ¡ dados salvos localmente
            const [token, savedUser] = await Promise.all([
                TokenManager.getAccessToken(),
                AsyncStorage.getItem('user'),
            ]);

            if (token && savedUser) {
                const userData = JSON.parse(savedUser);

                // Definir dados no cache
                queryClient.setQueryData(queryKeys.auth.user, userData);

                // Verificar validade do token em background
                checkAuthStatus().catch(console.error);
            }
        } catch (error) {
            console.error('âŒ Erro ao inicializar auth:', error);
        }
    };

    // ğŸ“Š Estados derivados
    const isAuthenticated = !!userQuery.data;
    const user = userQuery.data;
    const isLoading = userQuery.isLoading || loginMutation.isPending || registerMutation.isPending;

    return {
        // ğŸ“Š Estados
        user,
        isAuthenticated,
        isLoading,

        // ğŸ” Status das operaÃ§Ãµes
        isLoginLoading: loginMutation.isPending,
        isRegisterLoading: registerMutation.isPending,
        isLogoutLoading: logoutMutation.isPending,
        isChangePasswordLoading: changePasswordMutation.isPending,
        isForgotPasswordLoading: forgotPasswordMutation.isPending,

        // âŒ Erros
        loginError: loginMutation.error?.message,
        registerError: registerMutation.error?.message,
        changePasswordError: changePasswordMutation.error?.message,
        forgotPasswordError: forgotPasswordMutation.error?.message,

        // âœ… Sucessos
        forgotPasswordSuccess: forgotPasswordMutation.isSuccess,
        changePasswordSuccess: changePasswordMutation.isSuccess,

        // ğŸ¯ AÃ§Ãµes
        login: loginMutation.mutate,
        register: registerMutation.mutate,
        logout: logoutMutation.mutate,
        changePassword: changePasswordMutation.mutate,
        forgotPassword: forgotPasswordMutation.mutate,

        // ğŸ”§ UtilitÃ¡rios
        checkAuthStatus,
        initializeAuth,

        // ğŸ§¹ Reset de erros
        clearErrors: () => {
            loginMutation.reset();
            registerMutation.reset();
            changePasswordMutation.reset();
            forgotPasswordMutation.reset();
        },
    };
};

export default useAuthQuery;
